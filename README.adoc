:encoding: utf-8
:lang: ja
:scripts: cjk
:media: prepress
:linkcss:
:stylesdir: css
:stylesheet: mystyle.css
:sectanchors:
:autofit-option:
:experimental:
:support-uri:
:original-support-uri:
:twoinches: width='360'
:full-width: width='100%'
:three-quarters-width: width='75%'
:two-thirds-width: width='66%'
:half-width: width='50%'
:half-size:
:one-thirds-width: width='33%'
:one-quarters-width: width='25%'
:thumbnail: width='60'
:imagesdir: images
:sourcesdir: codes
:icons: font
:hide-uri-scheme!:
:figure-caption: 図
:example-caption: リスト
:table-caption: 表
:appendix-caption: 付録
:xrefstyle: short
:section-refsig:
:chapter-refsig:


= park_ride_system

NOTE: この演習は、グループで成果に協力しつつ、各自が成果物を作成します。

* `slow_down_tracer` 、`sonar_bumper` 、`marker_reader` を元に、`park_ride_system` をシステムとして作成します。
* 所定のユースケース（利用するシナリオ）が実行できるようにします。

[[preparation]]
== 準備

. `codes` ディレクトリは空なので、自分が開発に使う元とする `sample04` あるいはその派生のコード（ `slow_down_tracer` など）の `codes` ディレクトリから必要なファイルをコピーしてきなさい。最初は、コピーしてきたコードで、コピー元と同じようビルド、実行できることを確認しておくとよいでしょう。
** `park_ride_system` のコードは、`park_ride_system` ディレクトリの `codes` ディレクトリの中に置きます。
** `park_ride_system/codes/app.c` のような配置になる。
. `sample04.asta` あるいはその派生モデルのファイル（ `sonar_bumper.asta` など）を複製して、 `park_ride_system.asta` を用意しなさい。
** `park_ride_system.asta` は、`park_ride_system` ディレクトリの `models` ディレクトリに置きます。


[[use_case]]
== 利用シナリオ

NOTE: このシナリオは、講義資料で説明したものの再掲です。

=== 周遊プランの設定

. 利用者は、ライドセンターで周遊プランを作成する
** 周遊する観光スポット（2つ以上）と、スポットを周遊する順序を指定する
. センター職員は、利用者の周遊プランをライドマーカーで設定する
. センター職員は、周遊プランを設定後、オートライドに読み込みを指示する
** 周遊プラン読み込み指示は、オートライドの操作卓（EV3本体のボタン）の下向きボタンに割り当てる（ように作成する）
. オートライドは徐行して周遊プランを読み、停車して利用者の乗車を待つ
** 乗車の有無は、シートに着座した・していないで判断する
** （オプション）オートライドは、利用者の乗車待ちになったら、誘導音を鳴らす

[NOTE]
--
周遊プランは、マーカーで設定する。黒から始まる最大3箇所が周遊プランになる。<<park_ride_planning>> の場合、読み取り方向だと赤、青、黄。

[[park_ride_planning]]
.周遊プランの読み込み
image::park_ride_planning.png[{half-width}]
--

=== 利用者の乗車から出発まで

. 利用者は、誘導音を確認したら、オートライドに乗車する
** シートに利用者を載せる
. オートライドは、利用者が乗車したら、利用者の走行開始指示を待つ
** 一定時間経っても乗車しない場合には、確認音を鳴らす
. 利用者は、オートライドの走行開始指示ボタンを押す
** 走行開始指示は、オートライドの操作卓（EV3本体のボタン）の上ボタンに割り当てられている
** 走行開始の際は、安全喚起のために、警告音を鳴らす
. オートライドは、走行開始指示を受け取ると、経路に沿って走行する

=== 観光スポットでの運用

. オートライドは、ライドストップの壁を識別したら、徐行しながらライドストップのマーカーを読み取る
. ライドストップがプランにないスポットの場合は、通常走行に戻り走行する
. ライドストップが停車スポットの場合は、停車して、利用者の降車を待つ
** 停車時には誘導音を鳴らして、利用者に到着を知らせ、降車を促す
. 利用者は、停車を確認したら、降車して観光スポットを観光する
. 利用者が観光している間、オートライドはライドスポットで待機する
** 観光中は、5秒（実世界の30分に相当）が経過する都度、確認音を鳴らして利用者に促す（限度が来たら置き去りにする？）
. 利用者は、観光が済んだら、オートライドに乗車する
. 利用者が乗車したら、オートライドは、利用者の走行開始指示を待つ
. 利用者が走行開始指示ボタンを押すと、オートライドは経路に沿って走行する

NOTE: 利用者は、そのスポットで観光せず（降車せず）に出発する場合、降車しなくても（乗車したまま）でも、利用者が走行開始指示ボタンを押すと、出発する

=== センター帰着時の運用

. オートライドは、ライドストップの壁を識別したら、徐行する
. オートライドは、ライドストップマーカーを読み取る
** センターには固有のマーカー色（黒）が割り当てられている
. ライドストップがライドセンターの場合は、停車して、利用者の降車を待つ
** （オプション）誘導音を鳴らして、利用者に降車を促す
. 利用者は、停車を確認したら、降車する
** 利用者をシートから降ろす
. オートライドは、次の利用者のためにライドセンターに待機する
** センター職員が周遊プランの読み込み指示を出すのを待つ

=== 近接時の安全対策

. オートライドは、前方監視部（ソナーバンパー）を備えている
** 走行中、停止中によらず、前方に障害がないか常に監視している
. オートライドは、自身の前方、距離A（15cm）に障害物や前を走行するオートライドを認識したら、徐行する（ <<distance_a>> ）
** 距離Aより大きくなった場合には、通常走行に戻る
. オートライドは、前方の障害やオートライドまでの距離が距離B（7cm）に達した場合、は停止する（ <<distance_b>> ）
** 距離Bより大きくなった場合には、徐行に戻る


[[distance_a]]
.距離Aまで近づいたときは徐行する
image::distance_a.png[{half-width}]

[[distance_b]]
.距離Bまで近づいたときは停止する
image::distance_b.png[{half-width}]


== モデル図を作成する

NOTE: `park_ride_system` のモデルファイルを用意していない場合には、 <<preparation>> の指示に従って、モデルファイルを用意しなさい。

=== park_ride_systemのクラス図を作成する

. `park_ride_system` のクラス図を追加しなさい。
** クラス図の名前を「`park_ride_system` のクラス図」としなさい。
. システムの主たるクラスは、 `auto_ride` クラスとしなさい。
** 必要な操作を `auto_ride` クラスに追加しなさい。
. 他に必要となるクラスについて、 `slow_down_tracer` 、`ride_stop_detector` 、`marker_reader` を参考にして追加しなさい。
. 作成したクラスの間に関連を引きなさい。
** 働き（操作）を利用するクラスから、その働きを提供するクラスへ向かって方向付きの関連を引きます。

NOTE: クラス図の作成と後述のステートマシン図の作成をいったきたりして作業するとよいでしょう。

=== park_rideクラスのステートマシン図を作成する

. `auto_ride` クラスのステートマシン図を追加しなさい。
** 構造ツリーで `auto_ride` クラスを選択して右クリックし、ポップアップメニューから「ステートマシン図」を選択します。
** 別の場所に図が作られてしまった場合は `auto_ride` クラスの中に移動します。
. <<use_case>> に合うように、状態、状態遷移、イベント、アクションを検討して、ステートマシン図を作成しなさい。


NOTE: 先述のクラス図の作成と、ステートマシン図の作成をいったきたりして作業するとよいでしょう。


IMPORTANT: 少し作図が進んだら、途中でもよいのでモデルファイルを保存し、コミットしておく。コミットログには、クラス図とステートマシン図をどの程度作成したかについて書いておく。

=== park_ride_systemのモデル図を保存する

* 作成したクラス図を `park_ride_system_class_01.png` として `images` ディレクトリに保存しなさい。
* 作成したステートマシン図を `park_ride_stm_01.png` として `images` ディレクトリに保存しなさい。

.`park_ride_system` のクラス図（保存できたら置き換わる）
image::park_ride_system_class_01.png[{full-width}]


.`park_ride` クラスのステートマシン図（保存できたら置き換わる）
image::park_ride_stm_01.png [{full-width}]


NOTE: 図を保存できたらコミットしなさい。

NOTE: ここまでのコミットが済んだら、一度プッシュしておきなさい。


== コードを作成する

NOTE: `park_ride_system` の `codes` ディレクトリの準備が終わっていない場合には、 <<preparation>> の指示に従って、 `codes` ディレクトリの準備を済ませなさい。

=== park_ride_systemのコードを作成する

. `park_ride_system` のコードを作成しなさい。
** `codes` ディレクトリにプログラムを作成しなさい。
. 作成したコードを、ビルドし、実行して、動作を確認しなさい。
** 設計上の問題なら、設計（モデル図）に戻って修正しなさい。
** 実装上の問題（変換ルール通り実装していなかった）なら、ルールに合うよう実装を修正しなさい。
** もし、元にした  `slow_down_tracer` 、`ride_stop_detector` 、`marker_reader` の段階での問題であれば、これらの演習に戻って問題を解消してから `park_ride_system` のモデル図を修正しなさい。


=== park_ride_systemのコードを保存する

. 作成した `park_ride_system/codes/park_ride/app.c` のうち、`park_ride` クラスの振る舞いを表す部分（ステートマシン図に対応する関数を抜粋して、下記に示しなさい。
** ここにコードを切り貼りするのではなく、修正したコードそのものを参照するかたちをとること。

NOTE: コードについては先にコミットしておくこと。

[source,c,linenums]
.`park_ride/app.c`
----
include::{sourcesdir}/park_ride/app.c[lines=1..-1]
----

NOTE: コードの一部を載せたい場合は、 `README.adoc` の上記部分を編集して、行範囲の指定（ `[lines=1..-1]` の部分）を編集して範囲を指定する。コードを分割して載せたい場合は `README.adoc` の上記部分を複製して、分割したい範囲に応じて行範囲の指定を調整する。コードを複数のファイルに分割して作成している場合は、ファイルごとにリストに載せておくこと。

== 動作の様子を動画に撮る

=== 準備

. YouTubeにアカウントを作成しなさい。
** GitHubアカウントを作成したメールアドレス（大学のメールアドレス）でYouTubeアカウントを作成しなさい。

=== 動画の撮影

作成した `park_ride_system` が動作している様子をスマートホンなどで動画に保存しなさい。

==== 動画1

次の動作を `park_ride_system_action01.mp4` に保存しなさい。

. 読み込んだプランが「赤、青、黄」だったら、観光スポットを「茶、赤、青、黄、緑」といった配置にしなさい。
. ライドセンターでプランを読み込み、利用者を乗車させ、観光スポットを周遊して（利用者が乗り降りして）、ライドセンターに戻り、利用者を降ろして、次の利用者のために待機する所までを録画しなさい。


==== 動画2

次の動作を `park_ride_system_action02.mp4` に保存しなさい。

. ダミーのオートライド（牛乳パックなど）を用意しなさい。
. （シーン1） ダミーが前の観光スポットに停車している状態で、オートライドが近づいて、距離Aで徐行し、距離Bで停止する様子。
. （シーン2） ダミーに距離Aまで近づいて徐行したら、ダミーが前進して距離Aより離れ、オートライドが通常走行に戻る様子。
. （シーン3） ダミーに距離Bまで近づいてオートライドが停止したら、ダミーが前進して距離Bより離れ、オートライドが除光に戻る様子。


=== 動画のアップロード

. 作成した動画をYouTubeにアップしなさい。
. アップした動画のURLを取得して、下記のダミーリンクを編集して、参照できるようにしなさい。

[NOTE]
--
YouTubeのリンクが `https://youtu.be/71gXzo7RDiw` だったら、 +
`video::71gXzo7RDiw[youtube,width=480,height=270]` のように修正する。

`width` や `height` は撮影した画角に合わせて調整するとよいだろう。
--

.park_ride_system_action01
video::71gXzo7RDiw[youtube,width=480,height=270]


.park_ride_system_action02
video::71gXzo7RDiw[youtube,width=480,height=270]
